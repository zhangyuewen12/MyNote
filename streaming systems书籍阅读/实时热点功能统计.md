实时热点功能统计

1.系统介绍

为实时统计页面用户功能的访问量，为业务开发部门提供开发决策以及提高系统服务质量，设计并实现实时统计用户行为的系统。首先通过Logstash采集业务系统的行为日志写入Kafka中，然后通过flink关联维度数据计算指标，最终写入ES中，系统设计如下图所示。

![image-20210326140303609](/Users/zyw/Library/Application Support/typora-user-images/image-20210326140303609.png)

2.存在的问题

这样的设计目前主要存在的问题是在维表Join的过程。

首先因为我们的业务系统输出的日志是关于用户与系统的交互数据，那么用户维度就应该是来自于用户维度数据和系统功能维度数据两个方面，但是这个两个维度数据却存储的在不同的存储介质上。

传统的维表Join主要方式有：

1. 预加载维表

   对于预加载维表的方式，主要就是在程序启动的时候通过直接读取维表数据，将数据全量加载到内存中，这种方式主要是适合维表数据量不大且维表信息更新需要重新启动程序。这种的方法的一个改进方式就是新建一个单独的线程，定期更新维表数据。

2. 热存储维表

   这种方式主要是通过将维表数据导入热存储设备中，通过异步IO查询，同时也可以利用客户端的cache将维表数据缓存到内存中，我们的系统设计就是采用的这种方式，这种方式主要适用于维表数据更新频率高，且可以接受维表数据更新带来的一定延迟。

3. 广播维表

   这种场景下，维表数据可以转换成实时流

4. temporal table function join

   主要适用于维表数据为changlog流的形式。

即使采用热存储的方式，我们的设计上还存在很多问题，具体的问题主要有

1. 维表数据来源不统一，对于维度数据来源于MySQL，Redis等多源介质，这样在实时统计中，需要建立的连接，查询消耗比较大，对维度数据库的影响是不可测的。尤其是对于非KV形式的数据库，Mysql严格意义上来说作为维度数据的存储来是不可靠的，如果维度数据过大，查询的时间消耗同样增加，Fink的维度关联带来难度。
2. 由于历史原因，人资很多业务系统日志的格式都是已经确定的，也就是输出的用户行为日志中，并不能完全说明用户的行为。这个给维度关联带来的很大困难，这种关联的直接影响就是在从Mysql这样的维度数据库查询时，不得不采用like的模糊查询。甚至于很多情况下，出现维度数据关联不上的问题。



