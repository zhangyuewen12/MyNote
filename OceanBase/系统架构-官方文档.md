

# 一、 OceanBase数据库的整体架构

<img src="/Users/zyw/Library/Application Support/typora-user-images/image-20221212110925019.png" alt="image-20221212110925019" style="zoom:50%;" />

OceanBase数据库采用Shared-Nothing架构，各个节点之间完全对等，每个节点都有自己的SQL引擎、存储引擎，运行在普通PC服务器组成的集群之上，具有可扩展、高可用性、低成本、云原生核心特性。

> 在并行计算体系结构实现中有很多可选的体系结构。
>
> \1. share-memory：多个cpu共享同一片内存，cpu之间通过内部通讯机制（interconnection network）进行通讯；
> \2. share-disk：每一个cpu使用自己的私有内存区域，通过内部通讯机制直接访问所有磁盘系统。
> \3. share-nothing：每一个cpu都有私有内存区域和私有磁盘空间，而且2个cpu不能访问相同磁盘空间，cpu之间的通讯通过网络连接。

OceanBase数据库的一个集群由如干个节点组成，这些节点分别属于若干个可用区Zone，每个节点属于一个可用区。可用区是一个逻辑概念，表示集群中具有相似硬件可用性的一组节点，它在不同的部署模式下代表不同的含义。例如当整个洁群部署在同一个数据中心时，一个可用区可以对应同一机架，同一个交换机等。当集群分布多个数据中心时候，每个可用区可以对应一个数据中心。



在OceanBase数据库中，一个表的数据可以按照某种划分规则水平拆分成为多个分片，每个分片叫做一个表分区，Partition。某行数据属于且只属于一个分区，分区的规则由用户在建表的时候指定，包含Hash，Ranger,List等类型的分区，还支持二级分区。对于二级分区，第二级的每个子分区是一个物理分区，而第一级分区只是一个逻辑概念。



为了能够保护数据，并在节点发生故障的时候不中断服务，每个分区有多个副本。一般来说，一个分区的多个副本分散在多个不同的Zone里。多个副本有且只有一个副本接收修改操作，叫做主副本Leader，其他副本叫做从副本，Follower。主从之间通过Multi-Paxos的分布式共识协议实现了副本之间的数据一致性。当主副本所在节点发生故障的时候，一个从节点会被选举成新的主节点并继续提供服务。



在集群的每个节点上会运行一个叫做Obeserver的服务进程，它内部包含多个操作系统线程。节点的功能都是对等的。每个服务负责自己所在节点上分区数据的存取，也负责路由到本机的SQL语句的解析和执行。这些服务进程之间通过TCP/IP协议进行通信。同时，每个服务会监听来自外部应用的连接请求，建立连接和数据库会话，并提供数据库服务。



为了简化大规模部署多个业务数据库的管理并减低资源成本，OceanBase数据库体统了独特的多租户特性，在一个OB集群内，可以创建跟多个互相之间隔离的数据库“实例”，叫做一个租户。从应用服务的视角来看，每个租户是一个独立的数据库。不仅如此，每个租户可以选择MYSQL或ORACLE兼容模式。应用连接到MYSQL租户后，可以在租户下创建用户、数据库，与一个独立的MYSQL库的使用体现是一样的。同样的，应用连接到Oracle租户也是一样。一个新的集群初始化之后，就会存在一个特殊的名为sys的租户，叫做系统租户。系统租户中保存了集群的元数据，是一个Mysql兼容模式的租户。



为了隔离租户资源，每个observer进程内可以有多个属于不同租户的虚拟容器，叫做资源单元UNIT。每个租户在多个节点的资源单元组成一个资源池。资源包括CPU和内存资源。

为了使OB数据库对应用程序屏蔽内部分区和副本分别等细节，使应用访问分布式数据想访问单机数据库一样简单，OB提供了Obproxy代理服务。应用程序不会直接与OBServer节点建立连接，而是连接obproxy，然后由obproxy转发SQL请求到合适的Observer节点。Obproxy是无状态的服务，多个obproxy节点通过负载均衡SLB对应用提供统一的网络地址。



# 二、多租户架构概述

OceanBase数据库采用了单集群多租户设计，天然支持云数据库架构，支持公有云，私有云，混合云等多种部署形式。

OceanBase 数据库通过租户实现资源隔离，让每个数据库服务的实例不感知其他实例的存在，并通过权限控制确保租户数据的安全性，配合OceanBase数据库强



大的可扩展性，能够提供安全、灵活的DBaas服务。

租户是一个逻辑概念。在oB数据库中，租户是资源分配的单位，是对数据库对象管理和资源管理的基础，对于系统运维，尤其是对于云数据库的运维有着重要的影响。租户在一定程度上相当于传统数据库的“实例”概念。租户之间是完全隔离的。在数据安全方面，OB数据库不允许跨租户的数据访问。以确保用户的数据资产没有被其他租户窃取。总体来说，租户Tenant即是各类数据库对象的容器，又是资源的容器。



# 三、兼容模式

OceanBase数据库在一个系统中可同时支持MySQL模式和Oracle模式两种模式的租户。用户在创建租户是，可选择创建MYSQL兼容模式的租户或Oracle模式的租户，租户模式一经确定就无法更改。所有数据类型，SQL功能，内部视图等相对应地与MYSQL数据库或Oracle数据保持一致。



## 四、系统租户

系统租户也成为sys租户，是OB数据库的系统内置租户。

系统租户主要有以下几个功能：

- 系统租户承载了所有租户的元数据存储和管理服务。例如，系统租户下存储了所有普通租户系统表的对象元数据和位置信息。
- 系统租户是分布式集群集中式策略的执行者。例如，只有在系统租户下，才可以执行轮转合并，删除或创建普通租户、修改系统配置项、负载均衡策略、自动容灾处理等操作。
- 系统租户管理和维护集群资源。例如系统租户下存储了集群中所有的OBserver的信息和Zone的信息。

系统租户在集群自举过程中创建，系统租户信息和资源的管理都是在RootService服务上完成，RootService简称RS，是启动在系统租户下__all_core_table表上主副本的一组服务。__all_core_table是系统的1号表，系统中所有表都可以通过1号表索引到。

## 4.1系统表分类

系统租户是一个MYSQL兼容租户，系统租户下的系统表主要分为以下几类：

- 对象元数据表

  系统租户下存储所有系统表的元数据。例如 '__all_core_table'  中存储了 __all_table表的元数据，'_all_table'  表中存储了其他系统表的元数据。

- 分区位置信息表

  系统租户下存储了系统表的位置信息。例如， [__all_core_table] 中存储了 [___all_root_table]的位置信息。 __all_root_table 中记录了其他系统表的位置信息。

- 集群资源相关表

  系统租户维护了所有机器的位置信息和分布信息。例如，在 __all_zone 表中记录了所有Zone信息，在[ ___ all_server] 表中维护了OBServer的信息。

- 租户原信息和资源相关表

  在系统租户下可以看到所有租户的元数据信息。例如，在__all_tenant表中可以看到集群中所有的租户以及租户的分布信息。

## 4.2 RS服务

RootService的功能主要包括集群自举、集群资源管理、DDL操作以及分布式集群集中式策略执行。

RootService的各功能的特点如下：

- 集群自举
  集群自举 是在OBServer启动成功后，创建系统租户和初始化配置的过程。也称Bootstrap。

  系统自举时需执行RootService的位置信息，BootStrap命令在RootService位置上创建__all_core_table。__all_core_table的Leader所在的Observer自动提供RootSerivce服务。RS启动后就可以创建系统租户、系统表、初始系统数据和集群配置。

- 集群资源管理

  Zone管理，在系统租户下，可以新增，删除，修改一个Zone。

  Unit管理，Unit的资源的最小分割单位，一组UNIT构成一个资源池，一个资源池可以被分配给一个租户，一个租户可以有多个资源池。在系统租户下，用户可以调整UNIT规格来调整资源池大小从而调整租户资源。

- OBServer管理

  每个OBServer都需要通过心跳来与RS保持通信。RS会根据心跳信息感知OBServer是否在线以及是否可以提供服务。系统租户下可以进行OBServer的增加，删除和停止服务。

- DDL操作

  所有的DDL操作都在RS上执行。

- 分布式系统集中式策略执行

  主备库集群角色切换

  合并管理

  租户管理

## 4.3高级特性

全局虚拟表

Alter System命令



# 5 普通租户

虽然普通租户与系统租户是独立且隔离的，但普通租户无法完成自举。普通租户系统表的元数据信息时引用系统租户的元数据信息；普通租户系统表的位置信息存储在系统租户的__all_root_table表中。

 

普通租户系统表的对象元数据信息和位置信息的分布如下图所示。



# 六、租户的资源管理